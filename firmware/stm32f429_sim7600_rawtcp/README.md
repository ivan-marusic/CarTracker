# Embedded Device (STM32F429 + SIM7600G-H CAT4 4G (LTE) Shield)
<p align="center">
<img src="../../images/STM32F429+SIM7600G-H.jpg" width="800" />
</p>

STM32F429 + SIM7600G‑H Raw TCP Telemetry Firmware
This firmware is part of the CarTracker system, a vehicle‑tracking solution that sends real‑time GPS coordinates from an embedded device to a cloud backend. The data is consumed by an Android application that displays the vehicle location using Firebase Realtime Database.

## Overview
This firmware runs on:

STM32F429 microcontroller
SIM7600G‑H 4G/LTE modem (UART communication)
GNSS receiver inside SIM7600

It uses the SIM7600's internal TCP/IP stack (not PPP, not LwIP) to establish a raw TCP connection directly to a custom server hosted on an Oracle Cloud VM. The server then forwards location data to Firebase Realtime Database over HTTPS.
The modem sends:
JSON{"latitude": <value>, "longitude": <value>, "timestamp": "<ISO8601>"} Prikaži više redaka
Each packet is a newline‑terminated JSON string.

## Features

Reads GNSS data using AT+CGNSINF
Formats timestamps into ISO‑8601 (YYYY-MM-DDTHH:MM:SSZ)
Connects to the cellular network using APN (e.g., "TM" or your provider)
Opens a raw TCP socket using:

AT+NETOPEN 
AT+CIPOPEN
AT+CIPSEND


Sends periodic location updates to the Oracle VM server
Automatically reconnects if the TCP link drops
No PPP
No LwIP
Very lightweight implementation suitable for bare‑metal or FreeRTOS

## Directory Structure
Core/Inc/
    sim7600.h        – AT command wrapper, TCP socket functions
    gnss.h           – GNSS location parser
    debug.h          – Logging macros (optional)
    
Core/Src/
    sim7600.c        – SIM7600 driver (TCP + GNSS)
    gnss.c           – GNSS parsing and ISO8601 formatting
    main.c           – Example application loop
    usart.c, gpio.c  – CubeMX generated peripheral setup
    
Drivers/             – STM32 HAL drivers generated by CubeMX

Project.ioc          – CubeMX configuration file

## How It Works (High‑Level Sequence)
1. Enable GNSS:
AT+CGNSPWR=1


2. Configure APN & open IP stack:
AT+CGDCONT=1,"IP","<APN>"
AT+NETOPEN


3. Open a TCP connection to the VM:
AT+CIPOPEN=0,"TCP","<VM-IP>",4000


4. Send JSON telemetry:
AT+CIPSEND=0,<len>
{"latitude":..., "longitude":..., "timestamp":"..."}

5. Python server receives this JSON → pushes to Firebase → Android app reads /location.

## Requirements

STM32CubeIDE
SIM7600G‑H module
Valid APN for your M2M SIM card
Python TCP relay running on your Oracle VM
Firebase Realtime Database enabled
Pmod USB‑UART(for debugging)

## Debugging Setup (Pmod USB‑UART Sniffer)

During development, I used a **Pmod USB‑UART adapter** connected to **UART5** on the STM32F429 in order to monitor all communication between the MCU (UART2) and the SIM7600G‑H modem.

Although the SIM7600G‑H is wired to **USART2** (PD5 = TX2, PD6 = RX2), I routed the transmitted AT commands and received modem responses into **USART5** so they could be viewed on a PC terminal at **115200 baud**.

This allows real‑time debugging of:
- All outgoing AT commands from STM32 → SIM7600  
- All incoming responses from SIM7600 → STM32  
- JSON packets being prepared for TCP upload  
- Errors such as `SEND FAIL`, `NETOPEN ERROR`, or malformed `+CGNSINF` output  

### **STM32 → Pmod USB‑UART wiring**

| STM32 Pin     | Function                   | Pmod USB‑UART |
|---------------|----------------------------|---------------|
| **PD2**       | UART5_RX  (receive log)    | TX            |
| **PC12**      | UART5_TX  (send debug)     | RX            |
| **GND**       | Ground                     | GND           |
| **Baudrate**  | 115200 8N1                 | —             |

### Monitoring USART2 via USART5

Even though **USART2** is the actual interface to the SIM7600G‑H module:

- **USART2_TX (PD5)** sends AT commands → modem  
- **USART2_RX (PD6)** receives responses ← modem  

I mirrored important log messages and raw AT traffic to **USART5**, so I could observe everything using the Pmod USB‑UART and a serial program such as PuTTY, Minicom, or CuteCom.

This “debug UART tapping” is extremely helpful for:
- Debugging new AT commands  
- Watching GNSS output changes  
- Inspecting TCP socket sequences (`NETOPEN`, `CIPOPEN`, `CIPSEND`)  
- Diagnosing connectivity failures over LTE  

### Debugging Adapter

![Pmod USB-UART](../../images/STM32F429+SIM7600G-H+PmodUSBUART.jpg)

## License

This firmware is part of the CarTracker project (MIT License applies to entire repository unless stated otherwise).
